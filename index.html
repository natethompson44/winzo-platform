<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WINZO American Football Betting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        winzo: {
                            primary: '#FF6B35',
                            secondary: '#1A1A1A',
                            accent: '#FFD700'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
            min-height: 100vh;
        }
        .bet-card {
            transition: all 0.3s ease;
        }
        .bet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
        }
        .bet-button {
            transition: all 0.2s ease;
        }
        .bet-button:hover {
            transform: scale(1.05);
        }
        .bet-button:active {
            transform: scale(0.95);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="bg-gradient-to-r from-winzo-primary to-winzo-accent p-4 shadow-lg">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-2xl font-bold">üèà WINZO American Football</h1>
                <div id="auth-section" class="flex items-center space-x-2 sm:space-x-4">
                    <div id="user-info" class="hidden flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <div class="flex items-center space-x-2 bg-gray-800 px-3 py-2 rounded-lg">
                            <span class="text-lg">üí∞</span>
                            <span id="user-balance" class="text-sm font-bold text-winzo-accent">$0.00</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="user-email" class="text-sm font-medium hidden sm:inline"></span>
                            <button id="logout-btn" class="text-sm underline hover:no-underline">Logout</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button id="my-bets-btn" class="bg-blue-600 hover:bg-blue-700 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium transition-all">
                                My Bets
                            </button>
                            <button id="deposit-btn" class="bg-green-600 hover:bg-green-700 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium transition-all">
                                Deposit
                            </button>
                            <button id="withdraw-btn" class="bg-red-600 hover:bg-red-700 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium transition-all">
                                Withdraw
                            </button>
                            <button id="admin-btn" class="bg-purple-600 hover:bg-purple-700 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium transition-all hidden">
                                Admin
                            </button>
                        </div>
                    </div>
                    <button id="login-btn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium transition-all">
                        Login / Register
                    </button>
                </div>
            </div>
            <p class="text-center text-sm opacity-90">Live NFL Betting</p>
            <div id="last-updated" class="text-center text-xs opacity-75 mt-1"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 pb-24">
        <!-- Games Section -->
        <section id="games-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-winzo-accent">Today's NFL Games</h2>
                <div id="loading-indicator" class="hidden">
                    <div class="loading-spinner w-5 h-5 border-2 border-winzo-primary border-t-transparent rounded-full"></div>
                </div>
            </div>
            <div id="games-container" class="space-y-4">
                <!-- Games will be loaded here -->
            </div>
            <div id="error-message" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4">
                <p class="font-medium">Unable to load live odds</p>
                <p class="text-sm mt-1">Using fallback data. Please check your internet connection.</p>
            </div>
        </section>
    </main>

    <!-- Bet Slip (Fixed Bottom) -->
    <div id="bet-slip" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 transform translate-y-full transition-transform duration-300 z-50">
        <div class="container mx-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-winzo-accent">Bet Slip</h3>
                <button id="close-bet-slip" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <div id="selected-bets" class="space-y-3 mb-4">
                <!-- Selected bets will appear here -->
            </div>
            
            <div id="bet-controls" class="space-y-4">
                <div>
                    <label for="stake-input" class="block text-sm font-medium mb-2">Stake Amount</label>
                    <input 
                        type="number" 
                        id="stake-input" 
                        placeholder="Enter stake amount" 
                        min="1" 
                        step="0.01"
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-winzo-primary focus:border-transparent"
                    >
                </div>
                
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between mb-2">
                        <span>Total Odds:</span>
                        <span id="total-odds" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span>Stake:</span>
                        <span id="stake-display" class="font-semibold">$0</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-winzo-accent">
                        <span>Potential Payout:</span>
                        <span id="potential-payout">$0</span>
                    </div>
                </div>
                
                <button 
                    id="place-bet" 
                    class="w-full bg-gradient-to-r from-winzo-primary to-winzo-accent text-white font-bold py-4 px-6 rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Place Bet
                </button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="auth-modal-title" class="text-xl font-semibold text-winzo-accent">Login</h3>
                <button id="close-auth-modal" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <div id="auth-tabs" class="flex mb-6">
                <button id="login-tab" class="flex-1 py-2 px-4 bg-winzo-primary text-white rounded-l-lg font-medium">
                    Login
                </button>
                <button id="register-tab" class="flex-1 py-2 px-4 bg-gray-700 text-gray-300 rounded-r-lg font-medium hover:bg-gray-600">
                    Register
                </button>
            </div>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium mb-2">Email</label>
                    <input 
                        type="email" 
                        id="auth-email" 
                        required
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-winzo-primary focus:border-transparent"
                        placeholder="Enter your email"
                    >
                </div>
                
                <div>
                    <label for="auth-password" class="block text-sm font-medium mb-2">Password</label>
                    <input 
                        type="password" 
                        id="auth-password" 
                        required
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-winzo-primary focus:border-transparent"
                        placeholder="Enter your password"
                    >
                </div>
                
                <div id="auth-error" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg">
                    <p id="auth-error-message"></p>
                </div>
                
                <button 
                    type="submit" 
                    id="auth-submit"
                    class="w-full bg-gradient-to-r from-winzo-primary to-winzo-accent text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="auth-submit-text">Login</span>
                    <div id="auth-loading" class="hidden">
                        <div class="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>
                    </div>
                </button>
            </form>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="deposit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-gray-800 rounded-lg p-4 sm:p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-winzo-accent">Deposit Funds</h3>
                <button id="close-deposit-modal" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <form id="deposit-form" class="space-y-4">
                <div>
                    <label for="deposit-amount" class="block text-sm font-medium mb-2">Amount ($)</label>
                    <input 
                        type="number" 
                        id="deposit-amount" 
                        required
                        min="1"
                        step="0.01"
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-winzo-primary focus:border-transparent"
                        placeholder="Enter amount to deposit"
                    >
                </div>
                
                <div id="deposit-error" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg">
                    <p id="deposit-error-message"></p>
                </div>
                
                <button 
                    type="submit" 
                    id="deposit-submit"
                    class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="deposit-submit-text">Deposit</span>
                    <div id="deposit-loading" class="hidden">
                        <div class="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>
                    </div>
                </button>
            </form>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-gray-800 rounded-lg p-4 sm:p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-winzo-accent">Withdraw Funds</h3>
                <button id="close-withdraw-modal" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <form id="withdraw-form" class="space-y-4">
                <div>
                    <label for="withdraw-amount" class="block text-sm font-medium mb-2">Amount ($)</label>
                    <input 
                        type="number" 
                        id="withdraw-amount" 
                        required
                        min="1"
                        step="0.01"
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-winzo-primary focus:border-transparent"
                        placeholder="Enter amount to withdraw"
                    >
                </div>
                
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="text-sm text-gray-400">Available Balance:</div>
                    <div id="available-balance" class="text-lg font-bold text-winzo-accent">$0.00</div>
                </div>
                
                <div id="withdraw-error" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg">
                    <p id="withdraw-error-message"></p>
                </div>
                
                <button 
                    type="submit" 
                    id="withdraw-submit"
                    class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="withdraw-submit-text">Withdraw</span>
                    <div id="withdraw-loading" class="hidden">
                        <div class="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full mx-auto"></div>
                    </div>
                </button>
            </form>
        </div>
    </div>

    <!-- My Bets Modal -->
    <div id="my-bets-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-gray-800 rounded-lg p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-winzo-accent">My Bets</h3>
                <button id="close-my-bets-modal" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <div id="my-bets-content" class="overflow-y-auto max-h-[70vh]">
                <div id="my-bets-loading" class="text-center py-8">
                    <div class="loading-spinner w-8 h-8 border-2 border-winzo-primary border-t-transparent rounded-full mx-auto"></div>
                    <p class="text-gray-400 mt-2">Loading your bets...</p>
                </div>
                
                <div id="my-bets-list" class="space-y-3 hidden">
                    <!-- Bets will be loaded here -->
                </div>
                
                <div id="my-bets-empty" class="text-center py-8 hidden">
                    <div class="text-gray-400 text-lg mb-2">No bets placed yet</div>
                    <p class="text-gray-500 text-sm">Start betting on today's games to see your history here!</p>
                </div>
                
                <div id="my-bets-error" class="text-center py-8 hidden">
                    <div class="text-red-400 text-lg mb-2">Error loading bets</div>
                    <p class="text-gray-500 text-sm">Please try again later</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-gray-800 rounded-lg p-4 sm:p-6 w-full max-w-6xl max-h-[95vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-winzo-accent">Admin Dashboard</h3>
                <button id="close-admin-modal" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <div id="admin-content" class="overflow-y-auto max-h-[85vh] space-y-6">
                <!-- System Health Card -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-white">System Health</h4>
                        <button id="refresh-health-btn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-medium transition-all">
                            Refresh
                        </button>
                    </div>
                    <div id="health-content">
                        <div id="health-loading" class="text-center py-4">
                            <div class="loading-spinner w-6 h-6 border-2 border-winzo-primary border-t-transparent rounded-full mx-auto"></div>
                            <p class="text-gray-400 mt-2 text-sm">Loading system health...</p>
                        </div>
                        <div id="health-data" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Health data will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Refresh Odds Card -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-white">Odds Management</h4>
                        <button id="refresh-odds-btn" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm font-medium transition-all">
                            Refresh Odds Cache
                        </button>
                    </div>
                    <p class="text-gray-400 text-sm">Manually refresh the odds cache to fetch the latest data from the API.</p>
                </div>

                <!-- Users Table -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-white">Users</h4>
                        <button id="refresh-users-btn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-medium transition-all">
                            Refresh
                        </button>
                    </div>
                    <div id="users-content">
                        <div id="users-loading" class="text-center py-8">
                            <div class="loading-spinner w-8 h-8 border-2 border-winzo-primary border-t-transparent rounded-full mx-auto"></div>
                            <p class="text-gray-400 mt-2">Loading users...</p>
                        </div>
                        <div id="users-table" class="hidden overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-600">
                                        <th class="text-left py-2 px-3">Email</th>
                                        <th class="text-left py-2 px-3">Balance</th>
                                        <th class="text-left py-2 px-3">Total Bets</th>
                                        <th class="text-left py-2 px-3">Winnings</th>
                                        <th class="text-left py-2 px-3">Losses</th>
                                        <th class="text-left py-2 px-3">Admin</th>
                                        <th class="text-left py-2 px-3">Joined</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="users-empty" class="text-center py-8 hidden">
                            <div class="text-gray-400 text-lg mb-2">No users found</div>
                        </div>
                        <div id="users-error" class="text-center py-8 hidden">
                            <div class="text-red-400 text-lg mb-2">Error loading users</div>
                            <p class="text-gray-500 text-sm">Please try again later</p>
                        </div>
                    </div>
                </div>

                <!-- Bets Table -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-white">All Bets</h4>
                        <button id="refresh-bets-btn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-medium transition-all">
                            Refresh
                        </button>
                    </div>
                    <div id="bets-content">
                        <div id="bets-loading" class="text-center py-8">
                            <div class="loading-spinner w-8 h-8 border-2 border-winzo-primary border-t-transparent rounded-full mx-auto"></div>
                            <p class="text-gray-400 mt-2">Loading bets...</p>
                        </div>
                        <div id="bets-table" class="hidden overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-600">
                                        <th class="text-left py-2 px-3">User</th>
                                        <th class="text-left py-2 px-3">Match</th>
                                        <th class="text-left py-2 px-3">Team</th>
                                        <th class="text-left py-2 px-3">Odds</th>
                                        <th class="text-left py-2 px-3">Stake</th>
                                        <th class="text-left py-2 px-3">Payout</th>
                                        <th class="text-left py-2 px-3">Status</th>
                                        <th class="text-left py-2 px-3">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="bets-tbody">
                                    <!-- Bets will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="bets-empty" class="text-center py-8 hidden">
                            <div class="text-gray-400 text-lg mb-2">No bets found</div>
                        </div>
                        <div id="bets-error" class="text-center py-8 hidden">
                            <div class="text-red-400 text-lg mb-2">Error loading bets</div>
                            <p class="text-gray-500 text-sm">Please try again later</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Bet Slip Button -->
    <button 
        id="bet-slip-toggle" 
        class="fixed bottom-6 right-6 bg-winzo-primary text-white w-14 h-14 rounded-full shadow-lg hover:bg-winzo-accent transition-colors z-40 hidden"
    >
        <span class="text-lg font-bold" id="bet-count">0</span>
    </button>

    <script>
        // Global variables
        let games = [];
        let selectedBets = [];
        let betSlipVisible = false;
        let refreshInterval = null;
        
        // Odds conversion functions
        function decimalToAmerican(decimalOdds) {
            if (decimalOdds >= 2.0) {
                return Math.round((decimalOdds - 1) * 100);
            } else {
                return Math.round(-100 / (decimalOdds - 1));
            }
        }
        
        function americanToDecimal(americanOdds) {
            if (americanOdds > 0) {
                return (americanOdds / 100) + 1;
            } else {
                return (100 / Math.abs(americanOdds)) + 1;
            }
        }
        
        function formatAmericanOdds(americanOdds) {
            return americanOdds > 0 ? `+${americanOdds}` : `${americanOdds}`;
        }
        
        // Authentication state
        let currentUser = null;
        let authToken = null;
        let isLoginMode = true;
        
        // API Configuration - Now using backend proxy
        // Get API base URL from environment or use Railway URL
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://winzo-platform-production-d306.up.railway.app';
        const API_URL = `${API_BASE_URL}/api/odds`;
        const CACHE_DURATION = 60 * 1000; // 60 seconds in milliseconds
        const CACHE_KEY = 'nfl_odds_cache';
        const CACHE_TIMESTAMP_KEY = 'nfl_odds_timestamp';

        // Cache management functions
        function getCachedOdds() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                
                if (!cachedData || !timestamp) {
                    return null;
                }
                
                const now = Date.now();
                const cacheAge = now - parseInt(timestamp);
                
                if (cacheAge < CACHE_DURATION) {
                    return JSON.parse(cachedData);
                }
                
                return null;
            } catch (error) {
                console.error('Error reading cache:', error);
                return null;
            }
        }

        function setCachedOdds(data) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
            } catch (error) {
                console.error('Error setting cache:', error);
            }
        }

        // Authentication functions
        function getStoredAuth() {
            try {
                const token = localStorage.getItem('auth_token');
                const user = localStorage.getItem('auth_user');
                if (token && user) {
                    authToken = token;
                    currentUser = JSON.parse(user);
                    return true;
                }
            } catch (error) {
                console.error('Error reading auth from storage:', error);
            }
            return false;
        }

        function storeAuth(token, user) {
            try {
                localStorage.setItem('auth_token', token);
                localStorage.setItem('auth_user', JSON.stringify(user));
                authToken = token;
                currentUser = user;
            } catch (error) {
                console.error('Error storing auth:', error);
            }
        }

        function clearAuth() {
            try {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('auth_user');
                authToken = null;
                currentUser = null;
            } catch (error) {
                console.error('Error clearing auth:', error);
            }
        }

        function updateAuthUI() {
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const userBalance = document.getElementById('user-balance');
            const loginBtn = document.getElementById('login-btn');
            const adminBtn = document.getElementById('admin-btn');

            if (currentUser) {
                userEmail.textContent = currentUser.email;
                userBalance.textContent = `$${(currentUser.balance || 0).toFixed(2)}`;
                userInfo.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                
                // Show admin button if user is admin
                if (currentUser.is_admin) {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
                
                // Load current balance from server
                loadWalletBalance();
            } else {
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                adminBtn.classList.add('hidden');
            }
        }

        async function register(email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    storeAuth(result.token, result.user);
                    updateAuthUI();
                    hideAuthModal();
                    showAuthSuccess('Registration successful!');
                    return true;
                } else {
                    showAuthError(result.error);
                    return false;
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthError('Network error. Please try again.');
                return false;
            }
        }

        async function login(email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    storeAuth(result.token, result.user);
                    updateAuthUI();
                    hideAuthModal();
                    showAuthSuccess('Login successful!');
                    return true;
                } else {
                    showAuthError(result.error);
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('Network error. Please try again.');
                return false;
            }
        }

        async function logout() {
            clearAuth();
            updateAuthUI();
            showAuthSuccess('Logged out successfully!');
        }

        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-email').focus();
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('auth-form').reset();
            hideAuthError();
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideAuthError() {
            document.getElementById('auth-error').classList.add('hidden');
        }

        function showAuthSuccess(message) {
            // Simple success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function switchAuthMode(isLogin) {
            isLoginMode = isLogin;
            const title = document.getElementById('auth-modal-title');
            const submitText = document.getElementById('auth-submit-text');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');

            if (isLogin) {
                title.textContent = 'Login';
                submitText.textContent = 'Login';
                loginTab.className = 'flex-1 py-2 px-4 bg-winzo-primary text-white rounded-l-lg font-medium';
                registerTab.className = 'flex-1 py-2 px-4 bg-gray-700 text-gray-300 rounded-r-lg font-medium hover:bg-gray-600';
            } else {
                title.textContent = 'Register';
                submitText.textContent = 'Register';
                loginTab.className = 'flex-1 py-2 px-4 bg-gray-700 text-gray-300 rounded-l-lg font-medium hover:bg-gray-600';
                registerTab.className = 'flex-1 py-2 px-4 bg-winzo-primary text-white rounded-r-lg font-medium';
            }
            hideAuthError();
        }

        // Wallet functions
        async function loadWalletBalance() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/wallet`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const userBalance = document.getElementById('user-balance');
                    userBalance.textContent = `$${result.balance.toFixed(2)}`;
                    
                    // Update currentUser balance
                    if (currentUser) {
                        currentUser.balance = result.balance;
                        storeAuth(authToken, currentUser);
                    }
                }
            } catch (error) {
                console.error('Error loading wallet balance:', error);
            }
        }

        // Modal management functions
        function showDepositModal() {
            document.getElementById('deposit-modal').classList.remove('hidden');
            document.getElementById('deposit-amount').focus();
            hideDepositError();
        }

        function hideDepositModal() {
            document.getElementById('deposit-modal').classList.add('hidden');
            document.getElementById('deposit-form').reset();
            hideDepositError();
        }

        function showWithdrawModal() {
            // Update available balance before showing modal
            updateAvailableBalance();
            document.getElementById('withdraw-modal').classList.remove('hidden');
            document.getElementById('withdraw-amount').focus();
            hideWithdrawError();
        }

        function hideWithdrawModal() {
            document.getElementById('withdraw-modal').classList.add('hidden');
            document.getElementById('withdraw-form').reset();
            hideWithdrawError();
        }

        function showMyBetsModal() {
            document.getElementById('my-bets-modal').classList.remove('hidden');
            loadMyBets();
        }

        function hideMyBetsModal() {
            document.getElementById('my-bets-modal').classList.add('hidden');
        }

        function updateAvailableBalance() {
            if (currentUser && currentUser.balance !== undefined) {
                const availableBalance = document.getElementById('available-balance');
                availableBalance.textContent = `$${currentUser.balance.toFixed(2)}`;
            }
        }

        // Error handling functions
        function showDepositError(message) {
            const errorDiv = document.getElementById('deposit-error');
            const errorMessage = document.getElementById('deposit-error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideDepositError() {
            document.getElementById('deposit-error').classList.add('hidden');
        }

        function showWithdrawError(message) {
            const errorDiv = document.getElementById('withdraw-error');
            const errorMessage = document.getElementById('withdraw-error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideWithdrawError() {
            document.getElementById('withdraw-error').classList.add('hidden');
        }

        // Deposit function
        async function depositFunds(amount) {
            if (!authToken) return false;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/deposit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Update balance display
                    const userBalance = document.getElementById('user-balance');
                    userBalance.textContent = `$${result.balance.toFixed(2)}`;
                    
                    // Update currentUser balance
                    if (currentUser) {
                        currentUser.balance = result.balance;
                        storeAuth(authToken, currentUser);
                    }
                    
                    showAuthSuccess(result.message);
                    return true;
                } else {
                    showDepositError(result.error);
                    return false;
                }
            } catch (error) {
                console.error('Deposit error:', error);
                showDepositError('Network error. Please try again.');
                return false;
            }
        }

        // Withdraw function
        async function withdrawFunds(amount) {
            if (!authToken) return false;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Update balance display
                    const userBalance = document.getElementById('user-balance');
                    userBalance.textContent = `$${result.balance.toFixed(2)}`;
                    
                    // Update currentUser balance
                    if (currentUser) {
                        currentUser.balance = result.balance;
                        storeAuth(authToken, currentUser);
                    }
                    
                    showAuthSuccess(result.message);
                    return true;
                } else {
                    showWithdrawError(result.error);
                    return false;
                }
            } catch (error) {
                console.error('Withdraw error:', error);
                showWithdrawError('Network error. Please try again.');
                return false;
            }
        }

        // Load user's bets
        async function loadMyBets() {
            if (!authToken) return;
            
            const loadingDiv = document.getElementById('my-bets-loading');
            const listDiv = document.getElementById('my-bets-list');
            const emptyDiv = document.getElementById('my-bets-empty');
            const errorDiv = document.getElementById('my-bets-error');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            listDiv.classList.add('hidden');
            emptyDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/bets`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const bets = result.bets;
                    
                    if (bets.length === 0) {
                        loadingDiv.classList.add('hidden');
                        emptyDiv.classList.remove('hidden');
                    } else {
                        renderMyBets(bets);
                        loadingDiv.classList.add('hidden');
                        listDiv.classList.remove('hidden');
                    }
                } else {
                    throw new Error(result.error || 'Failed to load bets');
                }
            } catch (error) {
                console.error('Error loading bets:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
            }
        }

        // Render user's bets
        function renderMyBets(bets) {
            const container = document.getElementById('my-bets-list');
            container.innerHTML = '';

            bets.forEach(bet => {
                const betElement = document.createElement('div');
                betElement.className = 'bg-gray-700 p-4 rounded-lg border border-gray-600';
                
                const statusColor = bet.status === 'won' ? 'text-green-400' : 
                                  bet.status === 'lost' ? 'text-red-400' : 'text-yellow-400';
                const statusText = bet.status === 'won' ? 'Won' : 
                                 bet.status === 'lost' ? 'Lost' : 'Pending';
                
                betElement.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-3">
                        <div class="flex-1 mb-2 sm:mb-0">
                            <div class="font-medium text-white mb-1 text-sm sm:text-base">${bet.match}</div>
                            <div class="text-xs sm:text-sm text-gray-300">Team: ${bet.team}</div>
                        </div>
                        <div class="text-left sm:text-right">
                            <div class="text-xs sm:text-sm text-gray-400">${new Date(bet.created_at).toLocaleDateString()}</div>
                            <div class="text-xs text-gray-500">${new Date(bet.created_at).toLocaleTimeString()}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
                        <div class="text-center">
                            <div class="text-xs text-gray-400">Odds</div>
                            <div class="font-semibold text-winzo-accent text-sm sm:text-base">${formatAmericanOdds(decimalToAmerican(bet.odds))}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-400">Stake</div>
                            <div class="font-semibold text-white text-sm sm:text-base">$${bet.stake.toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-400">Potential Payout</div>
                            <div class="font-semibold text-green-400 text-sm sm:text-base">$${bet.potential_payout.toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-400">Status</div>
                            <div class="font-semibold ${statusColor} text-sm sm:text-base">${statusText}</div>
                        </div>
                    </div>
                `;
                container.appendChild(betElement);
            });
        }

        // API functions - Updated to use backend
        async function fetchLiveOdds() {
            try {
                showLoading(true);
                hideError();
                
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'API request failed');
                }
                
                if (!Array.isArray(result.data)) {
                    throw new Error('Invalid API response format');
                }
                
                // Process backend data (convert American odds to decimal for calculations)
                const processedGames = result.data.map(game => ({
                    id: game.id,
                    homeTeam: game.home_team,
                    awayTeam: game.away_team,
                    homeOdds: americanToDecimal(game.home_odds),
                    awayOdds: americanToDecimal(game.away_odds),
                    date: game.date,
                    time: game.time,
                    commenceTime: game.commenceTime
                }));
                
                games = processedGames;
                setCachedOdds(games);
                updateLastUpdated();
                renderGames();
                showLoading(false);
                
                // Log cache status
                if (result.cached) {
                    console.log('Served cached data from backend');
                } else if (result.fallback) {
                    console.log('Backend served fallback data');
                } else {
                    console.log('Served fresh data from backend');
                }
                
                return games;
                
            } catch (error) {
                console.error('Error fetching live odds:', error);
                showLoading(false);
                showError();
                return await loadFallbackData();
            }
        }

        function formatGameDate(commenceTime) {
            if (!commenceTime) return 'TBD';
            const date = new Date(commenceTime);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatGameTime(commenceTime) {
            if (!commenceTime) return 'TBD';
            const date = new Date(commenceTime);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // Fallback data loading
        async function loadFallbackData() {
            try {
                const response = await fetch('odds.json');
                const data = await response.json();
                games = data.games.map(game => ({
                    ...game,
                    homeOdds: americanToDecimal(parseFloat(game.homeOdds)),
                    awayOdds: americanToDecimal(parseFloat(game.awayOdds))
                }));
                renderGames();
                return games;
            } catch (error) {
                console.error('Error loading fallback data:', error);
                // Ultimate fallback
                games = [
                    {
                        id: 1,
                        homeTeam: "Kansas City Chiefs",
                        awayTeam: "Buffalo Bills",
                        homeOdds: americanToDecimal(-118),
                        awayOdds: americanToDecimal(+110),
                        date: "Today",
                        time: "8:00 PM"
                    },
                    {
                        id: 2,
                        homeTeam: "Dallas Cowboys",
                        awayTeam: "Philadelphia Eagles",
                        homeOdds: americanToDecimal(+120),
                        awayOdds: americanToDecimal(-133),
                        date: "Today",
                        time: "4:25 PM"
                    }
                ];
                renderGames();
                return games;
            }
        }

        // UI helper functions
        function showLoading(show) {
            const indicator = document.getElementById('loading-indicator');
            if (show) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function showError() {
            document.getElementById('error-message').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        function updateLastUpdated() {
            const lastUpdated = document.getElementById('last-updated');
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Main data loading function
        async function loadGames() {
            // First try to load from cache
            const cachedData = getCachedOdds();
            if (cachedData) {
                games = cachedData;
                renderGames();
                updateLastUpdated();
            }
            
            // Always try to fetch fresh data
            await fetchLiveOdds();
        }

        // Auto-refresh function
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                await fetchLiveOdds();
            }, CACHE_DURATION);
        }

        // Render games to the page
        function renderGames() {
            const container = document.getElementById('games-container');
            container.innerHTML = '';

            if (games.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No games available</p>';
                return;
            }

            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'bet-card bg-gray-800 rounded-lg p-4 border border-gray-700';
                gameCard.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="text-sm text-gray-400">${game.date} at ${game.time}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button 
                            class="bet-button bg-gray-700 hover:bg-winzo-primary p-4 rounded-lg border border-gray-600 hover:border-winzo-primary transition-all"
                            data-game-id="${game.id}"
                            data-team="home"
                            data-team-name="${game.homeTeam}"
                            data-odds="${game.homeOdds}"
                        >
                            <div class="text-sm font-medium">${game.homeTeam}</div>
                            <div class="text-lg font-bold text-winzo-accent">${formatAmericanOdds(decimalToAmerican(game.homeOdds))}</div>
                        </button>
                        <button 
                            class="bet-button bg-gray-700 hover:bg-winzo-primary p-4 rounded-lg border border-gray-600 hover:border-winzo-primary transition-all"
                            data-game-id="${game.id}"
                            data-team="away"
                            data-team-name="${game.awayTeam}"
                            data-odds="${game.awayOdds}"
                        >
                            <div class="text-sm font-medium">${game.awayTeam}</div>
                            <div class="text-lg font-bold text-winzo-accent">${formatAmericanOdds(decimalToAmerican(game.awayOdds))}</div>
                        </button>
                    </div>
                `;
                container.appendChild(gameCard);
            });
            
            // Attach event delegation for bet buttons
            attachBetButtonListeners();
        }

        // Attach event listeners to bet buttons using event delegation
        function attachBetButtonListeners() {
            const container = document.getElementById('games-container');
            
            // Remove any existing listener to prevent duplicates
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);
            
            // Add single event listener to container
            newContainer.addEventListener('click', function(e) {
                const button = e.target.closest('.bet-button');
                if (!button) return;
                
                const gameId = parseInt(button.dataset.gameId);
                const team = button.dataset.team;
                const teamName = button.dataset.teamName;
                const odds = parseFloat(button.dataset.odds);
                
                selectBet(gameId, team, teamName, odds);
            });
        }

        // Select a bet
        function selectBet(gameId, team, teamName, odds) {
            console.log('selectBet triggered', { gameId, team, teamName, odds });
            
            // Check if this bet is already selected
            const existingBet = selectedBets.find(bet => bet.gameId === gameId);
            
            if (existingBet) {
                // Remove existing bet
                selectedBets = selectedBets.filter(bet => bet.gameId !== gameId);
                console.log('Removed existing bet, selectedBets:', selectedBets);
            } else {
                // Add new bet
                selectedBets.push({
                    gameId: gameId,
                    team: team,
                    teamName: teamName,
                    odds: odds
                });
                console.log('Added new bet, selectedBets:', selectedBets);
            }

            updateBetSlip();
            updateBetSlipToggle();
        }

        // Update bet slip display
        function updateBetSlip() {
            const container = document.getElementById('selected-bets');
            container.innerHTML = '';

            if (selectedBets.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No bets selected</p>';
                return;
            }

            selectedBets.forEach((bet, index) => {
                const betElement = document.createElement('div');
                betElement.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                betElement.innerHTML = `
                    <div>
                        <div class="font-medium">${bet.teamName}</div>
                        <div class="text-sm text-gray-400">Odds: ${formatAmericanOdds(decimalToAmerican(bet.odds))}</div>
                    </div>
                    <button 
                        onclick="removeBet(${index})"
                        class="text-red-400 hover:text-red-300 text-xl"
                    >
                        &times;
                    </button>
                `;
                container.appendChild(betElement);
            });

            calculatePayout();
        }

        // Remove a bet
        function removeBet(index) {
            console.log('removeBet called with index:', index, 'selectedBets before:', selectedBets);
            selectedBets.splice(index, 1);
            console.log('selectedBets after removal:', selectedBets);
            updateBetSlip();
            updateBetSlipToggle();
        }

        // Update bet slip toggle button
        function updateBetSlipToggle() {
            console.log('updateBetSlipToggle called, selectedBets.length:', selectedBets.length);
            
            const toggle = document.getElementById('bet-slip-toggle');
            const count = document.getElementById('bet-count');
            
            if (!toggle) {
                console.error('bet-slip-toggle element not found!');
                return;
            }
            
            if (!count) {
                console.error('bet-count element not found!');
                return;
            }
            
            if (selectedBets.length > 0) {
                toggle.classList.remove('hidden');
                count.textContent = selectedBets.length;
                console.log('Showing bet slip toggle with count:', selectedBets.length);
            } else {
                toggle.classList.add('hidden');
                console.log('Hiding bet slip toggle');
            }
        }

        // Calculate potential payout (parlay style)
        function calculatePayout() {
            const stakeInput = document.getElementById('stake-input');
            const stake = parseFloat(stakeInput.value) || 0;
            
            if (selectedBets.length === 0) {
                document.getElementById('total-odds').textContent = '-';
                document.getElementById('stake-display').textContent = '$0';
                document.getElementById('potential-payout').textContent = '$0';
                document.getElementById('place-bet').disabled = true;
                return;
            }

            // Calculate total odds (multiply all odds)
            const totalOdds = selectedBets.reduce((acc, bet) => acc * bet.odds, 1);
            const potentialPayout = stake * totalOdds;

            document.getElementById('total-odds').textContent = totalOdds.toFixed(2);
            document.getElementById('stake-display').textContent = `$${stake.toFixed(2)}`;
            document.getElementById('potential-payout').textContent = `$${potentialPayout.toFixed(2)}`;
            
            // Enable/disable place bet button
            document.getElementById('place-bet').disabled = stake <= 0 || selectedBets.length === 0;
        }

        // Show/hide bet slip
        function toggleBetSlip() {
            const betSlip = document.getElementById('bet-slip');
            betSlipVisible = !betSlipVisible;
            
            if (betSlipVisible) {
                betSlip.style.transform = 'translateY(0)';
            } else {
                betSlip.style.transform = 'translateY(100%)';
            }
        }

        // Place bet (updated to use authenticated API)
        async function placeBet() {
            if (selectedBets.length === 0) return;
            
            const stake = parseFloat(document.getElementById('stake-input').value);
            const totalOdds = selectedBets.reduce((acc, bet) => acc * bet.odds, 1);
            const payout = stake * totalOdds;
            
            // If user is logged in, save bet to backend
            if (currentUser && authToken) {
                try {
                    const betData = {
                        match: selectedBets.map(bet => {
                            const game = games.find(g => g.id === bet.gameId);
                            return game ? `${game.awayTeam} vs ${game.homeTeam}` : 'Unknown Match';
                        }).join(', '),
                        team: selectedBets.map(bet => bet.teamName).join(', '),
                        odds: totalOdds,
                        stake: stake,
                        potential_payout: payout
                    };

                    const response = await fetch(`${API_BASE_URL}/api/bet`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(betData)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update balance display if new balance is provided
                        if (result.new_balance !== undefined) {
                            const userBalance = document.getElementById('user-balance');
                            userBalance.textContent = `$${result.new_balance.toFixed(2)}`;
                            
                            // Update currentUser balance
                            if (currentUser) {
                                currentUser.balance = result.new_balance;
                                storeAuth(authToken, currentUser);
                            }
                        }
                        
                        showAuthSuccess(`Bet placed successfully!\n\nStake: $${stake.toFixed(2)}\nTotal Odds: ${totalOdds.toFixed(2)}\nPotential Payout: $${payout.toFixed(2)}\n\nBet saved to your account.`);
                        
                        // Refresh My Bets if the modal is open
                        if (!document.getElementById('my-bets-modal').classList.contains('hidden')) {
                            loadMyBets();
                        }
                    } else {
                        showAuthError(result.error || result.message || 'Failed to save bet');
                        return;
                    }
                } catch (error) {
                    console.error('Error saving bet:', error);
                    showAuthError('Failed to save bet. Please try again.');
                    return;
                }
            } else {
                // Show login prompt for unauthenticated users
                showAuthError('Please log in to place bets');
                showAuthModal();
                return;
            }
            
            // Clear the bet slip
            selectedBets = [];
            document.getElementById('stake-input').value = '';
            updateBetSlip();
            updateBetSlipToggle();
            toggleBetSlip();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize authentication
            getStoredAuth();
            updateAuthUI();
            
            loadGames();
            startAutoRefresh();
            
            // Bet slip toggle
            document.getElementById('bet-slip-toggle').addEventListener('click', toggleBetSlip);
            document.getElementById('close-bet-slip').addEventListener('click', toggleBetSlip);
            
            // Stake input
            document.getElementById('stake-input').addEventListener('input', calculatePayout);
            
            // Place bet button
            document.getElementById('place-bet').addEventListener('click', placeBet);
            
            // Close bet slip when clicking outside
            document.getElementById('bet-slip').addEventListener('click', function(e) {
                if (e.target === this) {
                    toggleBetSlip();
                }
            });
            
            // Authentication event listeners
            document.getElementById('login-btn').addEventListener('click', showAuthModal);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('close-auth-modal').addEventListener('click', hideAuthModal);
            
            // Wallet event listeners
            document.getElementById('deposit-btn').addEventListener('click', showDepositModal);
            document.getElementById('withdraw-btn').addEventListener('click', showWithdrawModal);
            document.getElementById('my-bets-btn').addEventListener('click', showMyBetsModal);
            document.getElementById('admin-btn').addEventListener('click', showAdminModal);
            
            // Modal close buttons
            document.getElementById('close-deposit-modal').addEventListener('click', hideDepositModal);
            document.getElementById('close-withdraw-modal').addEventListener('click', hideWithdrawModal);
            document.getElementById('close-my-bets-modal').addEventListener('click', hideMyBetsModal);
            document.getElementById('close-admin-modal').addEventListener('click', hideAdminModal);
            
            // Auth modal tabs
            document.getElementById('login-tab').addEventListener('click', () => switchAuthMode(true));
            document.getElementById('register-tab').addEventListener('click', () => switchAuthMode(false));
            
            // Auth form submission
            document.getElementById('auth-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const submitBtn = document.getElementById('auth-submit');
                const submitText = document.getElementById('auth-submit-text');
                const loading = document.getElementById('auth-loading');
                
                // Show loading state
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loading.classList.remove('hidden');
                
                try {
                    let success = false;
                    if (isLoginMode) {
                        success = await login(email, password);
                    } else {
                        success = await register(email, password);
                    }
                } finally {
                    // Hide loading state
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            });
            
            // Deposit form submission
            document.getElementById('deposit-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById('deposit-amount').value);
                const submitBtn = document.getElementById('deposit-submit');
                const submitText = document.getElementById('deposit-submit-text');
                const loading = document.getElementById('deposit-loading');
                
                // Show loading state
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loading.classList.remove('hidden');
                
                try {
                    const success = await depositFunds(amount);
                    if (success) {
                        hideDepositModal();
                    }
                } finally {
                    // Hide loading state
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            });
            
            // Withdraw form submission
            document.getElementById('withdraw-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                const submitBtn = document.getElementById('withdraw-submit');
                const submitText = document.getElementById('withdraw-submit-text');
                const loading = document.getElementById('withdraw-loading');
                
                // Show loading state
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loading.classList.remove('hidden');
                
                try {
                    const success = await withdrawFunds(amount);
                    if (success) {
                        hideWithdrawModal();
                    }
                } finally {
                    // Hide loading state
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            });
            
            // Close modals when clicking outside
            document.getElementById('auth-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAuthModal();
                }
            });
            
            document.getElementById('deposit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideDepositModal();
                }
            });
            
            document.getElementById('withdraw-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideWithdrawModal();
                }
            });
            
            document.getElementById('my-bets-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideMyBetsModal();
                }
            });

            document.getElementById('admin-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAdminModal();
                }
            });

            // Admin dashboard event listeners
            document.getElementById('refresh-health-btn').addEventListener('click', loadSystemHealth);
            document.getElementById('refresh-users-btn').addEventListener('click', loadAdminUsers);
            document.getElementById('refresh-bets-btn').addEventListener('click', loadAdminBets);
            document.getElementById('refresh-odds-btn').addEventListener('click', refreshOddsCache);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // Admin Dashboard Functions
        function showAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
            loadAdminData();
        }

        function hideAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
        }

        async function loadAdminData() {
            await Promise.all([
                loadSystemHealth(),
                loadAdminUsers(),
                loadAdminBets()
            ]);
        }

        async function loadSystemHealth() {
            const healthLoading = document.getElementById('health-loading');
            const healthData = document.getElementById('health-data');
            
            try {
                healthLoading.classList.remove('hidden');
                healthData.classList.add('hidden');
                
                const response = await fetch(`${API_BASE_URL}/api/admin/health`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    healthData.innerHTML = `
                        <div class="bg-gray-600 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Status</div>
                            <div class="text-green-400 font-semibold">${data.status}</div>
                        </div>
                        <div class="bg-gray-600 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Uptime</div>
                            <div class="text-white font-semibold">${data.uptime.formatted}</div>
                        </div>
                        <div class="bg-gray-600 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Users</div>
                            <div class="text-white font-semibold">${data.database.user_count}</div>
                        </div>
                        <div class="bg-gray-600 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Memory</div>
                            <div class="text-white font-semibold">${Math.round(data.system.memory_usage.heapUsed / 1024 / 1024)}MB</div>
                        </div>
                    `;
                    healthData.classList.remove('hidden');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading system health:', error);
                healthData.innerHTML = '<div class="text-red-400 text-center py-4">Error loading system health</div>';
                healthData.classList.remove('hidden');
            } finally {
                healthLoading.classList.add('hidden');
            }
        }

        async function loadAdminUsers() {
            const usersLoading = document.getElementById('users-loading');
            const usersTable = document.getElementById('users-table');
            const usersEmpty = document.getElementById('users-empty');
            const usersError = document.getElementById('users-error');
            const usersTbody = document.getElementById('users-tbody');
            
            try {
                usersLoading.classList.remove('hidden');
                usersTable.classList.add('hidden');
                usersEmpty.classList.add('hidden');
                usersError.classList.add('hidden');
                
                const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    if (result.data.length === 0) {
                        usersEmpty.classList.remove('hidden');
                    } else {
                        usersTbody.innerHTML = result.data.map(user => `
                            <tr class="border-b border-gray-600 hover:bg-gray-600">
                                <td class="py-2 px-3">${user.email}</td>
                                <td class="py-2 px-3">$${user.balance.toFixed(2)}</td>
                                <td class="py-2 px-3">${user.total_bets}</td>
                                <td class="py-2 px-3 text-green-400">$${user.total_winnings.toFixed(2)}</td>
                                <td class="py-2 px-3 text-red-400">$${user.total_losses.toFixed(2)}</td>
                                <td class="py-2 px-3">
                                    ${user.is_admin ? '<span class="bg-purple-600 text-white px-2 py-1 rounded text-xs">Admin</span>' : '<span class="text-gray-400">-</span>'}
                                </td>
                                <td class="py-2 px-3 text-xs text-gray-400">${new Date(user.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                        usersTable.classList.remove('hidden');
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                usersError.classList.remove('hidden');
            } finally {
                usersLoading.classList.add('hidden');
            }
        }

        async function loadAdminBets() {
            const betsLoading = document.getElementById('bets-loading');
            const betsTable = document.getElementById('bets-table');
            const betsEmpty = document.getElementById('bets-empty');
            const betsError = document.getElementById('bets-error');
            const betsTbody = document.getElementById('bets-tbody');
            
            try {
                betsLoading.classList.remove('hidden');
                betsTable.classList.add('hidden');
                betsEmpty.classList.add('hidden');
                betsError.classList.add('hidden');
                
                const response = await fetch(`${API_BASE_URL}/api/admin/bets`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    if (result.data.length === 0) {
                        betsEmpty.classList.remove('hidden');
                    } else {
                        betsTbody.innerHTML = result.data.map(bet => `
                            <tr class="border-b border-gray-600 hover:bg-gray-600">
                                <td class="py-2 px-3 text-sm">${bet.user_email}</td>
                                <td class="py-2 px-3 text-sm">${bet.match}</td>
                                <td class="py-2 px-3 text-sm">${bet.team}</td>
                                <td class="py-2 px-3 text-sm">${formatAmericanOdds(decimalToAmerican(bet.odds))}</td>
                                <td class="py-2 px-3 text-sm">$${bet.stake.toFixed(2)}</td>
                                <td class="py-2 px-3 text-sm">$${bet.potential_payout.toFixed(2)}</td>
                                <td class="py-2 px-3">
                                    <span class="px-2 py-1 rounded text-xs ${
                                        bet.status === 'won' ? 'bg-green-600 text-white' :
                                        bet.status === 'lost' ? 'bg-red-600 text-white' :
                                        'bg-yellow-600 text-white'
                                    }">${bet.status}</span>
                                </td>
                                <td class="py-2 px-3 text-xs text-gray-400">${new Date(bet.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                        betsTable.classList.remove('hidden');
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading bets:', error);
                betsError.classList.remove('hidden');
            } finally {
                betsLoading.classList.add('hidden');
            }
        }

        async function refreshOddsCache() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/refresh-odds`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAuthSuccess('Odds cache refreshed successfully!');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error refreshing odds cache:', error);
                showAuthError('Failed to refresh odds cache');
            }
        }

        function showAuthError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
